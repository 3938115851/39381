<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#1a1a2e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>狼人杀 - 多人在线推理游戏</title>
    
    <!-- Socket.IO Client -->
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    
    <!-- 统一的 Tailwind 配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#1a1a2e',
                        secondary: '#16213e',
                        accent: '#e94560',
                        dark: '#0f3460',
                        light: '#f5f5f5',
                        wolf: '#8b0000',
                        seer: '#1e3a8a',
                        witch: '#7e22ce',
                        hunter: '#dc2626',
                        guard: '#047857',
                        villager: '#6b7280',
                        success: '#10b981',
                        warning: '#f59e0b',
                        error: '#ef4444',
                        info: '#3b82f6'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                        'fade-in': 'fadeIn 0.5s ease-in-out',
                        'slide-up': 'slideUp 0.5s ease-in-out',
                        'slide-down': 'slideDown 0.5s ease-in-out',
                        'slide-left': 'slideLeft 0.5s ease-in-out',
                        'slide-right': 'slideRight 0.5s ease-in-out',
                        'shake': 'shake 0.5s ease-in-out',
                        'bounce-slow': 'bounce 2s infinite',
                        'ping-slow': 'ping 2s cubic-bezier(0, 0, 0.2, 1) infinite'
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideUp: {
                            '0%': { transform: 'translateY(20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                        slideDown: {
                            '0%': { transform: 'translateY(-20px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                        slideLeft: {
                            '0%': { transform: 'translateX(20px)', opacity: '0' },
                            '100%': { transform: 'translateX(0)', opacity: '1' },
                        },
                        slideRight: {
                            '0%': { transform: 'translateX(-20px)', opacity: '0' },
                            '100%': { transform: 'translateX(0)', opacity: '1' },
                        },
                        shake: {
                            '0%, 100%': { transform: 'rotate(-3deg)' },
                            '50%': { transform: 'rotate(3deg)' },
                        },
                    },
                    backgroundImage: {
                        'wolf-pattern': "url('https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/rc/pc/super_tool/c44c03669a1a4a0ba073af333bbc095a~tplv-a9rns2rl98-image.image?lk3s=8e244e95&rcl=202601291526017A1DD3BB98925F226B5E&rrcfp=f06b921b&x-expires=1772263634&x-signature=eKFw6r37e7JsQamPoPUU0Joht%2Bc%3D')",
                    }
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .text-shadow {
                text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
            }
            .text-shadow-lg {
                text-shadow: 0 4px 8px rgba(0, 0, 0, 0.5);
            }
            .bg-blur {
                backdrop-filter: blur(8px);
            }
            .scrollbar-hide::-webkit-scrollbar {
                display: none;
            }
            .scrollbar-hide {
                -ms-overflow-style: none;
                scrollbar-width: none;
            }
            .glass {
                background: rgba(255, 255, 255, 0.1);
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.2);
            }
            .glass-dark {
                background: rgba(0, 0, 0, 0.5);
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.1);
            }
            .role-icon {
                @apply w-16 h-16 rounded-full object-cover border-4 transition-all duration-300;
            }
            .role-icon-wolf {
                @apply border-wolf hover:border-red-600 hover:scale-110;
            }
            .role-icon-seer {
                @apply border-seer hover:border-blue-600 hover:scale-110;
            }
            .role-icon-witch {
                @apply border-witch hover:border-purple-600 hover:scale-110;
            }
            .role-icon-hunter {
                @apply border-hunter hover:border-red-600 hover:scale-110;
            }
            .role-icon-guard {
                @apply border-guard hover:border-green-600 hover:scale-110;
            }
            .role-icon-villager {
                @apply border-villager hover:border-gray-600 hover:scale-110;
            }
            .btn-primary {
                @apply bg-accent text-white font-bold py-4 px-8 rounded-lg shadow-lg hover:bg-red-600 transition-all duration-300 transform hover:scale-105 active:scale-95 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50 min-h-[56px] touch-manipulation;
            }
            .btn-secondary {
                @apply bg-secondary text-white font-bold py-4 px-8 rounded-lg shadow-lg hover:bg-blue-800 transition-all duration-300 transform hover:scale-105 active:scale-95 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-opacity-50 min-h-[56px] touch-manipulation;
            }
            .btn-outline {
                @apply border-2 border-accent text-accent font-bold py-4 px-8 rounded-lg shadow-lg hover:bg-accent hover:text-white transition-all duration-300 transform hover:scale-105 active:scale-95 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50 min-h-[56px] touch-manipulation;
            }
            .btn-sm {
                @apply bg-accent text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-red-600 transition-all duration-300 transform hover:scale-105 active:scale-95 focus:outline-none focus:ring-2 focus:ring-red-500 focus:ring-opacity-50 touch-manipulation;
            }
            .btn-group {
                @apply space-y-4;
            }
            .input-primary {
                @apply bg-dark bg-opacity-50 border-2 border-gray-700 text-white font-bold py-3 px-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-accent focus:border-transparent;
            }
            .card {
                @apply bg-dark bg-opacity-70 rounded-xl shadow-xl p-6 border border-gray-800;
            }
            .card-glass {
                @apply glass-dark rounded-xl shadow-xl p-6 border border-gray-800;
            }
            .progress-ring {
                transform: rotate(-90deg);
                transform-origin: 50% 50%;
            }
            .progress-ring-circle {
                transition: stroke-dashoffset 0.35s;
                stroke-width: 8;
                stroke-dasharray: 283;
                stroke-dashoffset: 283;
                stroke-linecap: round;
                fill: none;
            }
            .connection-status {
                @apply inline-flex items-center px-3 py-1 rounded-full text-sm font-medium;
            }
            .connection-status.connected {
                @apply bg-success text-white;
            }
            .connection-status.connecting {
                @apply bg-warning text-white;
            }
            .connection-status.disconnected {
                @apply bg-error text-white;
            }
            .notification {
                @apply fixed top-4 right-4 z-50 max-w-sm w-full bg-white shadow-lg rounded-lg p-4 transform transition-all duration-300;
            }
            .notification.success {
                @apply border-l-4 border-success;
            }
            .notification.error {
                @apply border-l-4 border-error;
            }
            .notification.warning {
                @apply border-l-4 border-warning;
            }
            .notification.info {
                @apply border-l-4 border-info;
            }
        }
    </style>
</head>

<body class="bg-primary min-h-screen font-sans text-light overflow-x-hidden">
    <!-- 背景图 -->
    <div class="fixed inset-0 bg-wolf-pattern bg-cover bg-center opacity-20 z-0"></div>
    
    <!-- 主容器 -->
    <div class="relative z-10 min-h-screen flex flex-col">
        <!-- 顶部导航栏 -->
        <header class="bg-dark bg-opacity-80 backdrop-blur-md shadow-lg py-4 px-6 sticky top-0 z-50">
            <div class="container mx-auto flex justify-between items-center">
                <div class="flex items-center space-x-3">
                    <img src="https://p3-flow-imagex-sign.byteimg.com/tos-cn-i-a9rns2rl98/rc/pc/super_tool/612500a0a94e491fa3f91ba64e3fcd73~tplv-a9rns2rl98-image.image?lk3s=8e244e95&rcl=202601291526017A1DD3BB98925F226B5E&rrcfp=f06b921b&x-expires=1772263653&x-signature=mvxrBwGuGHBr6UEYJfbKNRHpGIU%3D" alt="狼人杀Logo" class="w-12 h-12 rounded-full">
                    <h1 class="text-2xl font-bold text-shadow">狼人杀</h1>
                    <div id="connection-status" class="connection-status disconnected">
                        <i class="fa fa-circle mr-2"></i>
                        <span>连接中...</span>
                    </div>
                </div>
                <div class="hidden md:flex items-center space-x-4">
                    <button id="btn-rules" class="text-gray-300 hover:text-white transition-colors">
                        <i class="fa fa-book mr-2"></i>游戏规则
                    </button>
                    <button id="btn-help" class="text-gray-300 hover:text-white transition-colors">
                        <i class="fa fa-question-circle mr-2"></i>帮助
                    </button>
                    <button id="btn-settings" class="text-gray-300 hover:text-white transition-colors">
                        <i class="fa fa-cog mr-2"></i>设置
                    </button>
                    <button id="btn-server-status" class="text-gray-300 hover:text-white transition-colors">
                        <i class="fa fa-server mr-2"></i>服务器状态
                    </button>
                </div>
                <button id="btn-mobile-menu" class="md:hidden text-white text-2xl">
                    <i class="fa fa-bars"></i>
                </button>
            </div>
        </header>

        <!-- 移动端菜单 -->
        <div id="mobile-menu" class="hidden fixed inset-0 bg-black bg-opacity-90 z-50 flex flex-col items-center justify-center">
            <button id="btn-close-mobile-menu" class="absolute top-6 right-6 text-white text-2xl">
                <i class="fa fa-times"></i>
            </button>
            <div class="space-y-6 text-center">
                <button id="btn-rules-mobile" class="block text-2xl text-white hover:text-accent transition-colors">
                    <i class="fa fa-book mr-3"></i>游戏规则
                </button>
                <button id="btn-help-mobile" class="block text-2xl text-white hover:text-accent transition-colors">
                    <i class="fa fa-question-circle mr-3"></i>帮助
                </button>
                <button id="btn-settings-mobile" class="block text-2xl text-white hover:text-accent transition-colors">
                    <i class="fa fa-cog mr-3"></i>设置
                </button>
                <button id="btn-server-status-mobile" class="block text-2xl text-white hover:text-accent transition-colors">
                    <i class="fa fa-server mr-3"></i>服务器状态
                </button>
            </div>
        </div>

        <!-- 主内容区域 -->
        <main class="flex-1 container mx-auto px-4 py-8">
            <!-- 首页 -->
            <div id="home-page" class="fade-in">
                <div class="max-w-4xl mx-auto text-center">
                    <div class="mb-8">
                        <h2 class="text-4xl md:text-6xl font-bold text-shadow-lg mb-4">狼人杀</h2>
                        <p class="text-xl md:text-2xl text-gray-300 mb-8">多人在线推理游戏</p>
                        <div class="flex flex-col md:flex-row justify-center space-y-4 md:space-y-0 md:space-x-6">
                            <button id="btn-create-room" class="btn-primary">
                                <i class="fa fa-plus mr-2"></i>创建房间
                            </button>
                            <button id="btn-join-room" class="btn-secondary">
                                <i class="fa fa-sign-in mr-2"></i>加入房间
                            </button>
                            <button id="btn-quick-join" class="btn-outline">
                                <i class="fa fa-bolt mr-2"></i>快速加入
                            </button>
                        </div>
                    </div>
                    
                    <!-- 服务器状态卡片 -->
                    <div id="server-status-card" class="card-glass max-w-md mx-auto mb-8 hidden">
                        <h3 class="text-xl font-bold mb-4">服务器状态</h3>
                        <div class="space-y-2 text-left">
                            <div class="flex justify-between">
                                <span>连接状态:</span>
                                <span id="server-connection-status" class="font-bold">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span>活跃房间:</span>
                                <span id="server-rooms-count" class="font-bold">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span>在线玩家:</span>
                                <span id="server-players-count" class="font-bold">-</span>
                            </div>
                            <div class="flex justify-between">
                                <span>服务器时间:</span>
                                <span id="server-time" class="font-bold">-</span>
                            </div>
                        </div>
                    </div>

                    <!-- 游戏特色 -->
                    <div class="grid md:grid-cols-3 gap-6 mt-12">
                        <div class="card text-center">
                            <i class="fa fa-users text-4xl text-accent mb-4"></i>
                            <h3 class="text-xl font-bold mb-2">多人实时对战</h3>
                            <p class="text-gray-300">支持6-12人同时在线游戏，体验真实的狼人杀乐趣</p>
                        </div>
                        <div class="card text-center">
                            <i class="fa fa-shield text-4xl text-accent mb-4"></i>
                            <h3 class="text-xl font-bold mb-2">完整角色系统</h3>
                            <p class="text-gray-300">包含狼人、预言家、女巫、猎人、守卫、村民等经典角色</p>
                        </div>
                        <div class="card text-center">
                            <i class="fa fa-mobile text-4xl text-accent mb-4"></i>
                            <h3 class="text-xl font-bold mb-2">移动端优化</h3>
                            <p class="text-gray-300">完美适配手机和平板设备，随时随地畅玩游戏</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 创建房间页面 -->
            <div id="create-room-page" class="hidden">
                <div class="max-w-md mx-auto">
                    <div class="card">
                        <h2 class="text-2xl font-bold mb-6 text-center">创建房间</h2>
                        <form id="create-room-form">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">房间名称</label>
                                    <input type="text" id="room-name" class="input-primary w-full" placeholder="请输入房间名称" required>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">房间密码</label>
                                    <input type="password" id="room-password" class="input-primary w-full" placeholder="可选，设置房间密码">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">玩家数量</label>
                                    <select id="player-count" class="input-primary w-full">
                                        <option value="6">6人局</option>
                                        <option value="7">7人局</option>
                                        <option value="8">8人局</option>
                                        <option value="9">9人局</option>
                                        <option value="10">10人局</option>
                                        <option value="11">11人局</option>
                                        <option value="12">12人局</option>
                                    </select>
                                </div>
                                <div class="btn-group">
                                    <button type="submit" class="btn-primary w-full">
                                        <i class="fa fa-plus mr-2"></i>创建房间
                                    </button>
                                    <button type="button" id="btn-back-home" class="btn-outline w-full">
                                        <i class="fa fa-arrow-left mr-2"></i>返回首页
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- 加入房间页面 -->
            <div id="join-room-page" class="hidden">
                <div class="max-w-md mx-auto">
                    <div class="card">
                        <h2 class="text-2xl font-bold mb-6 text-center">加入房间</h2>
                        <form id="join-room-form">
                            <div class="space-y-4">
                                <div>
                                    <label class="block text-sm font-medium mb-2">房间号</label>
                                    <input type="text" id="join-room-id" class="input-primary w-full" placeholder="请输入6位房间号" required maxlength="6">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">房间密码</label>
                                    <input type="password" id="join-room-password" class="input-primary w-full" placeholder="如房间有密码，请在此输入">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium mb-2">玩家昵称</label>
                                    <input type="text" id="player-name" class="input-primary w-full" placeholder="请输入您的昵称" required>
                                </div>
                                <div class="btn-group">
                                    <button type="submit" class="btn-primary w-full">
                                        <i class="fa fa-sign-in mr-2"></i>加入房间
                                    </button>
                                    <button type="button" id="btn-back-home-join" class="btn-outline w-full">
                                        <i class="fa fa-arrow-left mr-2"></i>返回首页
                                    </button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>

            <!-- 房间页面 -->
            <div id="room-page" class="hidden">
                <div class="max-w-4xl mx-auto">
                    <div class="card">
                        <div class="flex justify-between items-center mb-6">
                            <h2 class="text-2xl font-bold" id="room-title">房间号: <span id="room-id-display">-</span></h2>
                            <div class="flex space-x-2">
                                <button id="btn-copy-room-id" class="btn-sm">
                                    <i class="fa fa-copy mr-1"></i>复制房间号
                                </button>
                                <button id="btn-leave-room" class="btn-sm bg-error">
                                    <i class="fa fa-sign-out mr-1"></i>离开房间
                                </button>
                            </div>
                        </div>
                        
                        <!-- 玩家列表 -->
                        <div class="mb-6">
                            <h3 class="text-xl font-bold mb-4">玩家列表 (<span id="players-count">0</span>/<span id="max-players">6</span>)</h3>
                            <div id="players-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                                <!-- 玩家列表将通过Socket.IO动态更新 -->
                            </div>
                        </div>

                        <!-- 房间控制 -->
                        <div class="flex justify-between items-center">
                            <div class="flex items-center space-x-4">
                                <button id="btn-toggle-ready" class="btn-primary">
                                    <i class="fa fa-check mr-2"></i>准备
                                </button>
                                <span id="ready-status" class="text-gray-300">点击准备按钮开始游戏</span>
                            </div>
                            <div>
                                <button id="btn-start-game" class="btn-primary hidden">
                                    <i class="fa fa-play mr-2"></i>开始游戏
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- 聊天区域 -->
                    <div class="card mt-6">
                        <h3 class="text-xl font-bold mb-4">聊天室</h3>
                        <div class="space-y-4">
                            <div id="chat-messages" class="h-48 overflow-y-auto scrollbar-hide bg-dark bg-opacity-50 rounded-lg p-4">
                                <!-- 聊天消息将通过Socket.IO动态更新 -->
                            </div>
                            <div class="flex space-x-2">
                                <input type="text" id="chat-input" class="input-primary flex-1" placeholder="输入消息..." maxlength="200">
                                <button id="btn-send-message" class="btn-primary">
                                    <i class="fa fa-paper-plane"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 游戏页面 -->
            <div id="game-page" class="hidden">
                <div class="max-w-6xl mx-auto">
                    <!-- 游戏信息区域 -->
                    <div class="card mb-6">
                        <div class="flex justify-between items-center">
                            <div>
                                <h2 class="text-2xl font-bold">游戏进行中</h2>
                                <p id="game-phase" class="text-gray-300">第1天 - 夜晚</p>
                            </div>
                            <div class="text-right">
                                <p id="player-role" class="font-bold">您的角色: <span id="role-display">-</span></p>
                                <p id="player-status" class="text-sm text-gray-300">状态: <span id="status-display">-</span></p>
                            </div>
                        </div>
                    </div>

                    <!-- 游戏主区域 -->
                    <div class="grid lg:grid-cols-3 gap-6">
                        <!-- 玩家区域 -->
                        <div class="lg:col-span-2">
                            <div class="card">
                                <h3 class="text-xl font-bold mb-4">玩家状态</h3>
                                <div id="game-players-list" class="grid grid-cols-2 md:grid-cols-3 gap-4">
                                    <!-- 游戏玩家列表将通过Socket.IO动态更新 -->
                                </div>
                            </div>
                        </div>

                        <!-- 行动区域 -->
                        <div>
                            <div class="card">
                                <h3 class="text-xl font-bold mb-4">行动区域</h3>
                                <div id="action-area" class="space-y-4">
                                    <!-- 行动区域内容将根据游戏阶段动态更新 -->
                                </div>
                            </div>

                            <!-- 游戏日志 -->
                            <div class="card mt-6">
                                <h3 class="text-xl font-bold mb-4">游戏日志</h3>
                                <div id="game-log" class="h-48 overflow-y-auto scrollbar-hide bg-dark bg-opacity-50 rounded-lg p-4 text-sm">
                                    <!-- 游戏日志将通过Socket.IO动态更新 -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- 底部信息 -->
        <footer class="bg-dark bg-opacity-80 py-4 mt-auto">
            <div class="container mx-auto text-center text-gray-400">
                <p>© 2024 狼人杀游戏 - 多人在线推理游戏</p>
                <p class="text-sm mt-1">基于 Socket.IO 构建的实时多人游戏</p>
            </div>
        </footer>
    </div>

    <!-- 模态框容器 -->
    <div id="modal-container">
        <!-- 各种模态框将通过JavaScript动态创建 -->
    </div>

    <!-- Socket.IO 客户端脚本 -->
    <script>
        // Socket.IO连接管理
        class SocketManager {
            constructor() {
                this.socket = null;
                this.isConnected = false;
                this.reconnectAttempts = 0;
                this.maxReconnectAttempts = 5;
                this.reconnectInterval = 3000;
                this.heartbeatInterval = null;
                
                // 服务器配置
                this.serverUrls = [
                    'http://localhost:3000',
                    'http://127.0.0.1:3000',
                    'https://39381-production.up.railway.app'
                ];
                
                this.currentServerIndex = 0;
                this.userInfo = null;
                this.currentRoom = null;
            }

            // 初始化Socket连接
            init() {
                this.updateConnectionStatus('connecting', '连接中...');
                
                const serverUrl = this.getCurrentServerUrl();
                
                this.socket = io(serverUrl, {
                    transports: ['websocket', 'polling'],
                    reconnection: true,
                    reconnectionAttempts: this.maxReconnectAttempts,
                    reconnectionDelay: this.reconnectInterval,
                    timeout: 10000,
                    forceNew: true
                });

                this.setupEventListeners();
            }

            // 获取当前服务器URL
            getCurrentServerUrl() {
                // 优先使用本地开发服务器
                if (window.location.hostname === 'localhost' || 
                    window.location.hostname === '127.0.0.1') {
                    return this.serverUrls[0];
                }
                
                // 生产环境使用Railway服务器
                return this.serverUrls[2];
            }

            // 设置事件监听器
            setupEventListeners() {
                // 连接事件
                this.socket.on('connect', () => {
                    console.log('Socket.IO连接成功');
                    this.isConnected = true;
                    this.reconnectAttempts = 0;
                    this.updateConnectionStatus('connected', '已连接');
                    this.showNotification('success', '连接成功', '已连接到游戏服务器');
                    
                    // 启动心跳检测
                    this.startHeartbeat();
                    
                    // 获取服务器状态
                    this.getServerStatus();
                });

                this.socket.on('disconnect', (reason) => {
                    console.log('Socket.IO连接断开:', reason);
                    this.isConnected = false;
                    this.updateConnectionStatus('disconnected', '连接断开');
                    this.showNotification('warning', '连接断开', '正在尝试重新连接...');
                    
                    // 停止心跳检测
                    this.stopHeartbeat();
                });

                this.socket.on('connect_error', (error) => {
                    console.error('Socket.IO连接错误:', error);
                    this.updateConnectionStatus('disconnected', '连接失败');
                    
                    // 尝试切换到备用服务器
                    this.switchToBackupServer();
                });

                this.socket.on('reconnect', (attemptNumber) => {
                    console.log(`Socket.IO重连成功，尝试次数: ${attemptNumber}`);
                    this.isConnected = true;
                    this.updateConnectionStatus('connected', '已重连');
                    this.showNotification('success', '重连成功', '已重新连接到服务器');
                    
                    // 重新加入房间（如果之前有房间）
                    if (this.currentRoom) {
                        this.rejoinRoom();
                    }
                });

                this.socket.on('reconnect_attempt', (attemptNumber) => {
                    console.log(`Socket.IO重连尝试: ${attemptNumber}`);
                    this.updateConnectionStatus('connecting', `重连中... (${attemptNumber}/${this.maxReconnectAttempts})`);
                });

                this.socket.on('reconnect_failed', () => {
                    console.error('Socket.IO重连失败');
                    this.updateConnectionStatus('disconnected', '连接失败');
                    this.showNotification('error', '连接失败', '无法连接到服务器，请检查网络连接');
                });

                // 连接确认事件
                this.socket.on('connection_established', (data) => {
                    console.log('服务器连接确认:', data);
                    this.userInfo = {
                        id: data.socketId,
                        name: `玩家${Math.floor(Math.random() * 1000)}`
                    };
                });

                // 房间相关事件
                this.socket.on('create_room_success', this.handleCreateRoomSuccess.bind(this));
                this.socket.on('join_room_success', this.handleJoinRoomSuccess.bind(this));
                this.socket.on('join_room_error', this.handleJoinRoomError.bind(this));
                this.socket.on('player_joined', this.handlePlayerJoined.bind(this));
                this.socket.on('player_left', this.handlePlayerLeft.bind(this));
                this.socket.on('player_disconnected', this.handlePlayerDisconnected.bind(this));
                this.socket.on('player_ready_changed', this.handlePlayerReadyChanged.bind(this));
                this.socket.on('game_started', this.handleGameStarted.bind(this));
                this.socket.on('game_state_updated', this.handleGameStateUpdated.bind(this));
                this.socket.on('game_message', this.handleGameMessage.bind(this));
                this.socket.on('game_over', this.handleGameOver.bind(this));
                this.socket.on('seer_check_result', this.handleSeerCheckResult.bind(this));
                
                // 聊天事件
                this.socket.on('chat_message', this.handleChatMessage.bind(this));
                
                // 服务器状态事件
                this.socket.on('server_status', this.handleServerStatus.bind(this));
                this.socket.on('heartbeat_ack', this.handleHeartbeatAck.bind(this));
            }

            // 切换到备用服务器
            switchToBackupServer() {
                this.currentServerIndex = (this.currentServerIndex + 1) % this.serverUrls.length;
                console.log(`切换到备用服务器: ${this.getCurrentServerUrl()}`);
                
                // 延迟重连，避免频繁切换
                setTimeout(() => {
                    if (this.socket) {
                        this.socket.disconnect();
                    }
                    this.init();
                }, 2000);
            }

            // 启动心跳检测
            startHeartbeat() {
                this.heartbeatInterval = setInterval(() => {
                    if (this.isConnected) {
                        this.socket.emit('heartbeat');
                    }
                }, 30000); // 每30秒发送一次心跳
            }

            // 停止心跳检测
            stopHeartbeat() {
                if (this.heartbeatInterval) {
                    clearInterval(this.heartbeatInterval);
                    this.heartbeatInterval = null;
                }
            }

            // 获取服务器状态
            getServerStatus() {
                if (this.isConnected) {
                    this.socket.emit('get_server_status');
                }
            }

            // 创建房间
            createRoom(roomData) {
                if (!this.isConnected) {
                    this.showNotification('error', '连接错误', '请先连接到服务器');
                    return false;
                }

                this.socket.emit('create_room', roomData);
                return true;
            }

            // 加入房间
            joinRoom(joinData) {
                if (!this.isConnected) {
                    this.showNotification('error', '连接错误', '请先连接到服务器');
                    return false;
                }

                this.socket.emit('join_room', joinData);
                return true;
            }

            // 离开房间
            leaveRoom() {
                if (this.currentRoom && this.isConnected) {
                    this.socket.emit('leave_room', { roomId: this.currentRoom.id });
                    this.currentRoom = null;
                }
            }

            // 重新加入房间
            rejoinRoom() {
                if (this.currentRoom && this.userInfo) {
                    const joinData = {
                        roomId: this.currentRoom.id,
                        username: this.userInfo.name
                    };
                    this.joinRoom(joinData);
                }
            }

            // 发送聊天消息
            sendChatMessage(message) {
                if (this.currentRoom && this.isConnected) {
                    this.socket.emit('chat_message', {
                        roomId: this.currentRoom.id,
                        message: message
                    });
                }
            }

            // 游戏行动
            sendGameAction(actionData) {
                if (this.currentRoom && this.isConnected) {
                    this.socket.emit('game_action', {
                        roomId: this.currentRoom.id,
                        ...actionData
                    });
                }
            }

            // 更新连接状态显示
            updateConnectionStatus(status, message) {
                const statusElement = document.getElementById('connection-status');
                if (statusElement) {
                    statusElement.className = `connection-status ${status}`;
                    statusElement.innerHTML = `<i class="fa fa-circle mr-2"></i><span>${message}</span>`;
                }
            }

            // 显示通知
            showNotification(type, title, message) {
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <h4 class="font-bold text-gray-900">${title}</h4>
                            <p class="text-sm text-gray-600 mt-1">${message}</p>
                        </div>
                        <button class="text-gray-400 hover:text-gray-600" onclick="this.parentElement.parentElement.remove()">
                            <i class="fa fa-times"></i>
                        </button>
                    </div>
                `;
                
                document.body.appendChild(notification);
                
                // 自动移除通知
                setTimeout(() => {
                    if (notification.parentElement) {
                        notification.remove();
                    }
                }, 5000);
            }

            // 事件处理函数
            handleCreateRoomSuccess(data) {
                console.log('房间创建成功:', data);
                this.currentRoom = data.room;
                this.userInfo = data.user;
                
                // 切换到房间页面
                this.showRoomPage(data.room);
                this.showNotification('success', '房间创建成功', `房间号: ${data.room.id}`);
            }

            handleJoinRoomSuccess(data) {
                console.log('加入房间成功:', data);
                this.currentRoom = data.room;
                this.userInfo = data.user;
                
                // 切换到房间页面
                this.showRoomPage(data.room);
                this.showNotification('success', '加入成功', `已加入房间: ${data.room.name}`);
            }

            handleJoinRoomError(data) {
                console.error('加入房间失败:', data);
                this.showNotification('error', '加入失败', data.message);
            }

            handlePlayerJoined(data) {
                console.log('玩家加入:', data);
                this.updatePlayersList(data.room);
                this.addChatMessage('system', `${data.player.name} 加入了房间`);
            }

            handlePlayerLeft(data) {
                console.log('玩家离开:', data);
                this.updatePlayersList(data.room);
                this.addChatMessage('system', `${data.player.name} 离开了房间`);
            }

            handlePlayerDisconnected(data) {
                console.log('玩家断开连接:', data);
                this.updatePlayersList(data.room);
                this.addChatMessage('system', `${data.player.name} 断开了连接`);
            }

            handlePlayerReadyChanged(data) {
                console.log('玩家准备状态改变:', data);
                this.updatePlayersList(data.room);
            }

            handleGameStarted(data) {
                console.log('游戏开始:', data);
                this.currentRoom = data.room;
                this.showGamePage(data.room);
                this.showNotification('success', '游戏开始', '游戏已开始，请查看您的角色');
            }

            handleGameStateUpdated(data) {
                console.log('游戏状态更新:', data);
                this.currentRoom = data.room;
                this.updateGameState(data.room);
            }

            handleGameMessage(data) {
                console.log('游戏消息:', data);
                this.addGameLog(data.message);
            }

            handleGameOver(data) {
                console.log('游戏结束:', data);
                this.showNotification('success', '游戏结束', `${data.winner} 获胜！`);
                // 可以添加游戏结束后的处理逻辑
            }

            handleSeerCheckResult(data) {
                console.log('预言家查验结果:', data);
                this.showNotification('info', '查验结果', `${data.target} 是 ${data.isWolf ? '狼人' : '好人'}`);
            }

            handleChatMessage(data) {
                console.log('聊天消息:', data);
                this.addChatMessage('player', data.message, data.userName);
            }

            handleServerStatus(data) {
                console.log('服务器状态:', data);
                this.updateServerStatus(data);
            }

            handleHeartbeatAck(data) {
                console.log('心跳确认:', data);
                // 心跳正常，无需特殊处理
            }

            // 页面显示函数
            showRoomPage(room) {
                // 隐藏其他页面
                document.getElementById('home-page').classList.add('hidden');
                document.getElementById('create-room-page').classList.add('hidden');
                document.getElementById('join-room-page').classList.add('hidden');
                document.getElementById('game-page').classList.add('hidden');
                
                // 显示房间页面
                document.getElementById('room-page').classList.remove('hidden');
                
                // 更新房间信息
                document.getElementById('room-id-display').textContent = room.id;
                document.getElementById('room-title').textContent = `房间: ${room.name}`;
                document.getElementById('max-players').textContent = room.playerCount;
                
                // 更新玩家列表
                this.updatePlayersList(room);
                
                // 显示房主控制按钮
                const startButton = document.getElementById('btn-start-game');
                if (this.userInfo && this.userInfo.isHost) {
                    startButton.classList.remove('hidden');
                } else {
                    startButton.classList.add('hidden');
                }
            }

            showGamePage(room) {
                // 隐藏其他页面
                document.getElementById('home-page').classList.add('hidden');
                document.getElementById('create-room-page').classList.add('hidden');
                document.getElementById('join-room-page').classList.add('hidden');
                document.getElementById('room-page').classList.add('hidden');
                
                // 显示游戏页面
                document.getElementById('game-page').classList.remove('hidden');
                
                // 更新游戏信息
                this.updateGameState(room);
            }

            updatePlayersList(room) {
                const playersList = document.getElementById('players-list');
                const playersCount = document.getElementById('players-count');
                
                playersCount.textContent = room.players.length;
                
                playersList.innerHTML = room.players.map(player => `
                    <div class="card p-4 flex items-center space-x-3">
                        <div class="w-12 h-12 bg-accent rounded-full flex items-center justify-center">
                            <i class="fa fa-user text-white text-xl"></i>
                        </div>
                        <div class="flex-1">
                            <h4 class="font-bold">${player.name}</h4>
                            <div class="flex items-center space-x-2 text-sm text-gray-300">
                                ${player.isHost ? '<span class="bg-accent px-2 py-1 rounded">房主</span>' : ''}
                                ${player.isReady ? '<span class="bg-success px-2 py-1 rounded">已准备</span>' : '<span class="bg-warning px-2 py-1 rounded">未准备</span>'}
                            </div>
                        </div>
                    </div>
                `).join('');
            }

            updateGameState(room) {
                // 更新游戏阶段显示
                const phaseElement = document.getElementById('game-phase');
                phaseElement.textContent = `第${room.gameState.dayCount}天 - ${room.gameState.phase === 'night' ? '夜晚' : '白天'}`;
                
                // 更新玩家角色和状态
                const currentPlayer = room.players.find(p => p.id === this.userInfo.id);
                if (currentPlayer) {
                    document.getElementById('role-display').textContent = this.getRoleName(currentPlayer.role);
                    document.getElementById('status-display').textContent = currentPlayer.isAlive ? '存活' : '死亡';
                }
                
                // 更新玩家列表
                this.updateGamePlayersList(room);
                
                // 更新行动区域
                this.updateActionArea(room);
            }

            updateGamePlayersList(room) {
                const gamePlayersList = document.getElementById('game-players-list');
                
                gamePlayersList.innerHTML = room.players.map(player => `
                    <div class="card p-3 text-center ${!player.isAlive ? 'opacity-50' : ''}">
                        <div class="w-16 h-16 mx-auto mb-2 rounded-full flex items-center justify-center ${this.getRoleColor(player.role)}">
                            <i class="fa ${this.getRoleIcon(player.role)} text-white text-2xl"></i>
                        </div>
                        <h4 class="font-bold text-sm">${player.name}</h4>
                        <p class="text-xs text-gray-300">${this.getRoleName(player.role)}</p>
                        <p class="text-xs ${player.isAlive ? 'text-success' : 'text-error'}">${player.isAlive ? '存活' : '死亡'}</p>
                    </div>
                `).join('');
            }

            updateActionArea(room) {
                const actionArea = document.getElementById('action-area');
                const currentPlayer = room.players.find(p => p.id === this.userInfo.id);
                
                if (!currentPlayer || !currentPlayer.isAlive) {
                    actionArea.innerHTML = '<p class="text-gray-300 text-center">您已死亡，无法行动</p>';
                    return;
                }
                
                // 根据游戏阶段和玩家角色显示行动选项
                if (room.gameState.phase === 'night') {
                    this.showNightActions(room, currentPlayer);
                } else {
                    this.showDayActions(room, currentPlayer);
                }
            }

            showNightActions(room, player) {
                const actionArea = document.getElementById('action-area');
                
                switch (room.gameState.currentAction) {
                    case 'wolf':
                        if (player.role === 'wolf') {
                            actionArea.innerHTML = `
                                <h4 class="font-bold mb-2">狼人行动</h4>
                                <p class="text-sm text-gray-300 mb-4">请选择要击杀的玩家</p>
                                <div class="space-y-2">
                                    ${this.getAlivePlayersOptions(room.players, 'wolfKill')}
                                </div>
                            `;
                        } else {
                            actionArea.innerHTML = '<p class="text-gray-300 text-center">狼人正在行动...</p>';
                        }
                        break;
                        
                    case 'seer':
                        if (player.role === 'seer') {
                            actionArea.innerHTML = `
                                <h4 class="font-bold mb-2">预言家行动</h4>
                                <p class="text-sm text-gray-300 mb-4">请选择要查验的玩家</p>
                                <div class="space-y-2">
                                    ${this.getAlivePlayersOptions(room.players, 'seerCheck')}
                                </div>
                            `;
                        } else {
                            actionArea.innerHTML = '<p class="text-gray-300 text-center">预言家正在行动...</p>';
                        }
                        break;
                        
                    default:
                        actionArea.innerHTML = '<p class="text-gray-300 text-center">等待其他玩家行动...</p>';
                }
            }

            showDayActions(room, player) {
                const actionArea = document.getElementById('action-area');
                actionArea.innerHTML = `
                    <h4 class="font-bold mb-2">白天讨论</h4>
                    <p class="text-sm text-gray-300 mb-4">请投票放逐可疑的玩家</p>
                    <div class="space-y-2">
                        ${this.getAlivePlayersOptions(room.players, 'vote')}
                    </div>
                `;
            }

            getAlivePlayersOptions(players, actionType) {
                const alivePlayers = players.filter(p => p.isAlive && p.id !== this.userInfo.id);
                return alivePlayers.map(player => `
                    <button class="w-full btn-secondary text-left" onclick="socketManager.sendGameAction({actionType: '${actionType}', targetId: '${player.id}'})">
                        <i class="fa fa-user mr-2"></i>${player.name}
                    </button>
                `).join('');
            }

            addChatMessage(type, message, userName = '系统') {
                const chatMessages = document.getElementById('chat-messages');
                const messageElement = document.createElement('div');
                messageElement.className = 'text-sm mb-2';
                messageElement.innerHTML = `
                    <span class="font-bold ${type === 'system' ? 'text-accent' : 'text-info'}">${userName}:</span>
                    <span class="text-gray-300">${message}</span>
                    <span class="text-xs text-gray-500 ml-2">${new Date().toLocaleTimeString()}</span>
                `;
                chatMessages.appendChild(messageElement);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            addGameLog(message) {
                const gameLog = document.getElementById('game-log');
                const logElement = document.createElement('div');
                logElement.className = 'mb-1';
                logElement.innerHTML = `
                    <span class="text-gray-300">${message}</span>
                    <span class="text-xs text-gray-500 ml-2">${new Date().toLocaleTimeString()}</span>
                `;
                gameLog.appendChild(logElement);
                gameLog.scrollTop = gameLog.scrollHeight;
            }

            updateServerStatus(data) {
                const statusCard = document.getElementById('server-status-card');
                statusCard.classList.remove('hidden');
                
                document.getElementById('server-connection-status').textContent = '正常';
                document.getElementById('server-rooms-count').textContent = data.roomsCount || 0;
                document.getElementById('server-players-count').textContent = data.connectionStats?.activeConnections || 0;
                document.getElementById('server-time').textContent = new Date(data.serverTime).toLocaleTimeString();
            }

            // 工具函数
            getRoleName(role) {
                const roleNames = {
                    'wolf': '狼人',
                    'seer': '预言家',
                    'witch': '女巫',
                    'hunter': '猎人',
                    'guard': '守卫',
                    'villager': '村民'
                };
                return roleNames[role] || '未知';
            }

            getRoleIcon(role) {
                const roleIcons = {
                    'wolf': 'fa-paw',
                    'seer': 'fa-eye',
                    'witch': 'fa-flask',
                    'hunter': 'fa-crosshairs',
                    'guard': 'fa-shield',
                    'villager': 'fa-user'
                };
                return roleIcons[role] || 'fa-question';
            }

            getRoleColor(role) {
                const roleColors = {
                    'wolf': 'bg-wolf',
                    'seer': 'bg-seer',
                    'witch': 'bg-witch',
                    'hunter': 'bg-hunter',
                    'guard': 'bg-guard',
                    'villager': 'bg-villager'
                };
                return roleColors[role] || 'bg-gray-600';
            }
        }

        // 页面初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 创建Socket管理器实例
            window.socketManager = new SocketManager();
            
            // 初始化Socket连接
            socketManager.init();
            
            // 设置页面事件监听器
            setupEventListeners();
        });

        // 设置页面事件监听器
        function setupEventListeners() {
            // 首页按钮
            document.getElementById('btn-create-room').addEventListener('click', () => {
                showCreateRoomPage();
            });
            
            document.getElementById('btn-join-room').addEventListener('click', () => {
                showJoinRoomPage();
            });
            
            document.getElementById('btn-quick-join').addEventListener('click', () => {
                // 快速加入逻辑（可以随机加入一个可用房间）
                socketManager.showNotification('info', '快速加入', '正在寻找可用房间...');
            });
            
            // 创建房间表单
            document.getElementById('create-room-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const roomData = {
                    name: document.getElementById('room-name').value,
                    password: document.getElementById('room-password').value || null,
                    playerCount: parseInt(document.getElementById('player-count').value)
                };
                socketManager.createRoom(roomData);
            });
            
            // 加入房间表单
            document.getElementById('join-room-form').addEventListener('submit', (e) => {
                e.preventDefault();
                const joinData = {
                    roomId: document.getElementById('join-room-id').value,
                    password: document.getElementById('join-room-password').value || null,
                    username: document.getElementById('player-name').value
                };
                socketManager.joinRoom(joinData);
            });
            
            // 返回首页按钮
            document.getElementById('btn-back-home').addEventListener('click', showHomePage);
            document.getElementById('btn-back-home-join').addEventListener('click', showHomePage);
            
            // 房间页面按钮
            document.getElementById('btn-copy-room-id').addEventListener('click', () => {
                if (socketManager.currentRoom) {
                    navigator.clipboard.writeText(socketManager.currentRoom.id);
                    socketManager.showNotification('success', '复制成功', '房间号已复制到剪贴板');
                }
            });
            
            document.getElementById('btn-leave-room').addEventListener('click', () => {
                socketManager.leaveRoom();
                showHomePage();
            });
            
            document.getElementById('btn-toggle-ready').addEventListener('click', () => {
                if (socketManager.currentRoom && socketManager.userInfo) {
                    const currentReadyState = !socketManager.userInfo.isReady;
                    socketManager.socket.emit('toggle_ready', {
                        roomId: socketManager.currentRoom.id,
                        isReady: currentReadyState
                    });
                }
            });
            
            document.getElementById('btn-start-game').addEventListener('click', () => {
                if (socketManager.currentRoom) {
                    socketManager.socket.emit('start_game', {
                        roomId: socketManager.currentRoom.id
                    });
                }
            });
            
            // 聊天功能
            document.getElementById('btn-send-message').addEventListener('click', sendChatMessage);
            document.getElementById('chat-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendChatMessage();
                }
            });
            
            // 服务器状态按钮
            document.getElementById('btn-server-status').addEventListener('click', () => {
                socketManager.getServerStatus();
            });
            
            // 移动端菜单
            document.getElementById('btn-mobile-menu').addEventListener('click', () => {
                document.getElementById('mobile-menu').classList.remove('hidden');
            });
            
            document.getElementById('btn-close-mobile-menu').addEventListener('click', () => {
                document.getElementById('mobile-menu').classList.add('hidden');
            });
        }

        // 页面显示函数
        function showHomePage() {
            document.getElementById('home-page').classList.remove('hidden');
            document.getElementById('create-room-page').classList.add('hidden');
            document.getElementById('join-room-page').classList.add('hidden');
            document.getElementById('room-page').classList.add('hidden');
            document.getElementById('game-page').classList.add('hidden');
        }

        function showCreateRoomPage() {
            document.getElementById('home-page').classList.add('hidden');
            document.getElementById('create-room-page').classList.remove('hidden');
            document.getElementById('join-room-page').classList.add('hidden');
        }

        function showJoinRoomPage() {
            document.getElementById('home-page').classList.add('hidden');
            document.getElementById('create-room-page').classList.add('hidden');
            document.getElementById('join-room-page').classList.remove('hidden');
        }

        // 发送聊天消息
        function sendChatMessage() {
            const chatInput = document.getElementById('chat-input');
            const message = chatInput.value.trim();
            
            if (message && socketManager.isConnected) {
                socketManager.sendChatMessage(message);
                chatInput.value = '';
            }
        }
    </script>
</body>
</html>